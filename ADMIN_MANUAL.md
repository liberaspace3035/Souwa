# SOUWA - 管理者ログイン・管理画面操作マニュアル

## 📋 ドキュメント情報

**プロジェクト名**: SOUWA（送和）- 厳選最高品質日本食材 卸売直送サイト  
**対象**: システム管理者  
**最終更新**: 2025年12月10日  
**バージョン**: 1.0

---

## 🔐 管理者アカウントについて

### 管理者の役割
管理者アカウントは以下の機能にアクセスできます：
- **商品管理**: 商品の登録・編集・削除・一覧表示
- **NEWS管理**: ニュース・お知らせの登録・編集・削除・一覧表示
- **一般ユーザー機能**: すべての一般ユーザー機能も利用可能

### 管理者権限の判定
- データベースの`users`テーブルの`role`カラムが`'admin'`であるユーザーが管理者として認識されます
- 一般ユーザーは`role`が`'user'`（デフォルト）です

---

## 🚀 管理者アカウントの作成方法

### 方法1: Seederを使用（推奨・開発環境）

#### 手順
1. ターミナルでプロジェクトディレクトリに移動
2. 以下のコマンドを実行：

```bash
php artisan db:seed --class=AdminUserSeeder
```

#### 作成されるデフォルトアカウント
- **Email**: `admin@souwa.com`
- **Password**: `password`
- **Name**: `管理者`
- **Role**: `admin`

**⚠️ 注意**: 本番環境では必ずパスワードを変更してください。

---

### 方法2: Tinkerを使用（柔軟な設定が可能）

#### 手順
1. ターミナルでプロジェクトディレクトリに移動
2. 以下のコマンドを実行：

```bash
php artisan tinker
```

3. Tinkerプロンプトで以下のコードを実行：

```php
\App\Models\User::create([
    'name' => '管理者',
    'email' => 'admin@example.com',
    'password' => \Hash::make('your_secure_password'),
    'role' => 'admin',
]);
```

**パラメータ説明**:
- `name`: 管理者の表示名
- `email`: ログインに使用するメールアドレス（ユニークである必要があります）
- `password`: パスワード（`\Hash::make()`でハッシュ化）
- `role`: `'admin'`を指定

#### 既存ユーザーを管理者に変更する場合

```php
$user = \App\Models\User::where('email', 'user@example.com')->first();
$user->role = 'admin';
$user->save();
```

---

### 方法3: データベースに直接挿入（上級者向け）

SQLiteの場合：
```sql
INSERT INTO users (name, email, password, role, created_at, updated_at)
VALUES (
    '管理者',
    'admin@example.com',
    '$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi', -- 'password'のハッシュ
    'admin',
    datetime('now'),
    datetime('now')
);
```

**⚠️ 注意**: パスワードは必ずハッシュ化してください。上記のハッシュは`password`の例です。

---

## 🔑 ログイン方法

### ログインページへのアクセス
1. ブラウザでサイトにアクセス: `http://localhost:8000/`（開発環境の場合）
2. ログインページが表示されます

### ログイン手順
1. **メールアドレス**を入力（例: `admin@souwa.com`）
2. **パスワード**を入力（例: `password`）
3. **「ログイン状態を保持する」**にチェックを入れると、次回アクセス時に自動ログインされます（任意）
4. **「ログイン」ボタンをクリック**

### ログイン後の動作
- ログインに成功すると、自動的にホームページ（`/home`）にリダイレクトされます
- ヘッダー右上の「ログイン・登録」ボタンをクリックすると、管理者メニューが表示されます

---

## 🎛️ 管理画面へのアクセス方法

### 方法1: ヘッダーメニューから（推奨）

1. 管理者アカウントでログイン
2. ヘッダー右上の**「ログイン・登録」**ボタンをクリック
3. ドロップダウンメニューから以下を選択：
   - **商品管理** → `/admin/products`
   - **ニュース管理** → `/admin/news`

### 方法2: 直接URLでアクセス

以下のURLに直接アクセスできます：

#### 商品管理
- **一覧**: `http://localhost:8000/admin/products`
- **新規登録**: `http://localhost:8000/admin/products/create`
- **編集**: `http://localhost:8000/admin/products/{id}/edit`

#### ニュース管理
- **一覧**: `http://localhost:8000/admin/news`
- **新規登録**: `http://localhost:8000/admin/news/create`
- **編集**: `http://localhost:8000/admin/news/{id}/edit`

---

## 📊 管理機能一覧

### 1. 商品管理（`/admin/products`）

#### 機能
- **商品一覧表示**: 全商品を一覧表示（20件/ページ）
- **商品登録**: 新規商品の登録
- **商品編集**: 既存商品の情報変更
- **商品削除**: 商品の削除

#### 商品登録時に設定できる項目
- **商品名**（必須）
- **商品説明**（任意）
- **価格**（必須、数値）
- **商品画像**（任意、最大2MB）
- **カテゴリー**（8種類から選択）
  - 野菜
  - 果物
  - 肉類
  - 魚介類
  - 米・穀物
  - 調味料
  - 飲料
  - その他
- **在庫数**（必須、整数）
- **フラグ設定**（チェックボックス）
  - おすすめ商品（`is_featured`）
  - 期間限定（`is_limited`）
  - 新商品（`is_new`）

#### 操作手順

**商品を登録する**:
1. `/admin/products`にアクセス
2. **「新規商品を登録」**ボタンをクリック
3. フォームに必要情報を入力
4. **「登録」**ボタンをクリック

**商品を編集する**:
1. `/admin/products`にアクセス
2. 編集したい商品の**「編集」**ボタンをクリック
3. フォームの内容を変更
4. **「更新」**ボタンをクリック

**商品を削除する**:
1. `/admin/products`にアクセス
2. 削除したい商品の**「削除」**ボタンをクリック
3. 確認ダイアログで**「OK」**をクリック
4. 商品と関連画像が削除されます

---

### 2. ニュース管理（`/admin/news`）

#### 機能
- **ニュース一覧表示**: 全ニュースを一覧表示（20件/ページ）
- **ニュース登録**: 新規ニュースの登録
- **ニュース編集**: 既存ニュースの情報変更
- **ニュース削除**: ニュースの削除

#### ニュース登録時に設定できる項目
- **タイトル**（必須）
- **内容**（任意、テキストエリア）
- **画像**（任意、最大2MB）
- **リンクURL**（任意、外部リンク）
- **公開日**（任意、日付選択）
- **公開状態**（チェックボックス）
  - チェック: 公開済み（一般ユーザーに表示）
  - 未チェック: 下書き（一般ユーザーに非表示）

#### 操作手順

**ニュースを登録する**:
1. `/admin/news`にアクセス
2. **「新規ニュースを登録」**ボタンをクリック
3. フォームに必要情報を入力
4. **「公開状態」**にチェックを入れると即座に公開されます
5. **「登録」**ボタンをクリック

**ニュースを編集する**:
1. `/admin/news`にアクセス
2. 編集したいニュースの**「編集」**ボタンをクリック
3. フォームの内容を変更
4. **「更新」**ボタンをクリック

**ニュースを削除する**:
1. `/admin/news`にアクセス
2. 削除したいニュースの**「削除」**ボタンをクリック
3. 確認ダイアログで**「OK」**をクリック
4. ニュースと関連画像が削除されます

---

## 🔒 セキュリティ・権限管理

### 権限チェックの仕組み

#### AdminMiddleware
すべての管理画面ルート（`/admin/*`）は`AdminMiddleware`で保護されています。

**動作**:
1. ユーザーがログインしているか確認
2. ログインユーザーの`role`が`'admin'`か確認
3. 条件を満たさない場合、403エラー（Forbidden）を返す

**エラーメッセージ**: `管理者権限が必要です。`

### アクセス制御の流れ

```
ユーザーが管理画面にアクセス
    ↓
認証チェック（authミドルウェア）
    ↓
ログインしていない → ログインページ（/）にリダイレクト
    ↓
ログイン済み → 管理者権限チェック（adminミドルウェア）
    ↓
role !== 'admin' → 403エラー
    ↓
role === 'admin' → 管理画面を表示
```

### セキュリティのベストプラクティス

1. **強力なパスワードを使用**
   - 最低8文字以上
   - 大文字・小文字・数字・記号を組み合わせる
   - 本番環境では必ずデフォルトパスワードを変更

2. **定期的なパスワード変更**
   - 定期的にパスワードを変更することを推奨

3. **管理者アカウントの管理**
   - 必要最小限の数の管理者アカウントのみ作成
   - 不要になった管理者アカウントは削除または一般ユーザーに変更

4. **ログアウト**
   - 作業終了時は必ずログアウト
   - 共有PCでは特に注意

---

## 🚪 ログアウト方法

### 手順
1. ヘッダー右上の**「ログイン・登録」**ボタンをクリック
2. ドロップダウンメニューから**「ログアウト」**をクリック
3. ログインページ（`/`）にリダイレクトされます

---

## 🛠️ トラブルシューティング

### 問題1: ログインできない

**症状**: メールアドレスとパスワードを入力してもログインできない

**確認事項**:
1. メールアドレスが正しいか確認
2. パスワードが正しいか確認（大文字・小文字の区別あり）
3. アカウントが存在するか確認

**解決方法**:
```bash
php artisan tinker
```
```php
// ユーザーを確認
\App\Models\User::where('email', 'admin@souwa.com')->first();

// パスワードをリセット
$user = \App\Models\User::where('email', 'admin@souwa.com')->first();
$user->password = \Hash::make('new_password');
$user->save();
```

---

### 問題2: 管理画面にアクセスできない（403エラー）

**症状**: ログインはできるが、管理画面にアクセスすると「管理者権限が必要です。」と表示される

**原因**: ユーザーの`role`が`'admin'`ではない

**解決方法**:
```bash
php artisan tinker
```
```php
// ユーザーのroleを確認
$user = \App\Models\User::where('email', 'your_email@example.com')->first();
echo $user->role; // 'user'と表示される場合、管理者権限がない

// 管理者権限を付与
$user->role = 'admin';
$user->save();
```

---

### 問題3: 管理者アカウントが存在しない

**症状**: 初回セットアップで管理者アカウントを作成したい

**解決方法**:
```bash
# Seederを使用（推奨）
php artisan db:seed --class=AdminUserSeeder

# または Tinkerを使用
php artisan tinker
```
```php
\App\Models\User::create([
    'name' => '管理者',
    'email' => 'admin@example.com',
    'password' => \Hash::make('password'),
    'role' => 'admin',
]);
```

---

### 問題4: 画像がアップロードできない

**症状**: 商品やニュースの画像をアップロードしようとするとエラーが発生する

**確認事項**:
1. 画像ファイルサイズが2MB以下か確認
2. 画像形式が適切か確認（JPEG, PNG, GIF推奨）
3. ストレージリンクが作成されているか確認

**解決方法**:
```bash
# ストレージリンクを作成
php artisan storage:link

# ストレージディレクトリの権限を確認
ls -la storage/app/public/
```

---

### 問題5: セッションが切れる

**症状**: 作業中に突然ログアウトされる

**原因**: セッションの有効期限切れ

**解決方法**:
- **「ログイン状態を保持する」**にチェックを入れてログイン
- 長時間の作業中は定期的にページをリロード

---

## 📝 よくある質問（FAQ）

### Q1: 複数の管理者アカウントを作成できますか？
**A**: はい、可能です。`role`が`'admin'`のユーザーはすべて管理者として認識されます。

### Q2: 一般ユーザーを管理者に変更できますか？
**A**: はい、可能です。Tinkerを使用してユーザーの`role`を`'admin'`に変更してください。

### Q3: 管理者アカウントを削除できますか？
**A**: はい、可能です。ただし、最低1つの管理者アカウントは残すことを推奨します。

### Q4: パスワードを忘れた場合、リセットできますか？
**A**: 現在のバージョンではパスワードリセット機能は実装されていません。Tinkerを使用してパスワードを変更してください。

### Q5: 管理者専用のログインページはありますか？
**A**: いいえ、管理者と一般ユーザーは同じログインページ（`/`）を使用します。ログイン後、管理者権限に応じて管理機能が表示されます。

---

## 📞 サポート・問い合わせ

### 技術的な問題が発生した場合
1. エラーメッセージを確認
2. ブラウザのコンソールログを確認
3. Laravelのログファイルを確認: `storage/logs/laravel.log`

### ログの確認方法
```bash
# 最新のログを表示
tail -f storage/logs/laravel.log

# エラーのみを表示
grep "ERROR" storage/logs/laravel.log
```

---

## 📋 チェックリスト

### 初回セットアップ時
- [ ] 管理者アカウントを作成
- [ ] 管理者アカウントでログインできることを確認
- [ ] 管理画面にアクセスできることを確認
- [ ] 商品管理機能が動作することを確認
- [ ] ニュース管理機能が動作することを確認
- [ ] デフォルトパスワードを変更

### 日常的な運用時
- [ ] 定期的にパスワードを変更
- [ ] 不要な管理者アカウントを削除または一般ユーザーに変更
- [ ] ログを定期的に確認
- [ ] バックアップを定期的に取得

---

**最終更新日**: 2025年12月10日  
**ドキュメントバージョン**: 1.0  
**対象Laravelバージョン**: 12.10.1

